@page "/Ventas/Listados"
@using CCC_Rugby_Web.Utilities
@layout MainLayout
@attribute [Authorize]
@inject HttpClient httpClient
@inject IUtilities utilities



<CustomView Roles="pedidos">
    <MudContainer MaxWidth="MaxWidth.ExtraExtraLarge" Class="pa-4 d-flex flex-column" Style="height: 100%; overflow: hidden;">
        <MudText>@CurrentPage.ToString()</MudText>
        <MudPaper Class="pa-4 mb-4" Style="flex-shrink: 0;">
            <MudGrid Spacing="5" Class="width:100%; justify-start justify-md-center" Style="align-items:center">
                <MudItem xs="12" sm="6" md="3" Class="d-flex align-center">
                    <MudSelect Variant="Variant.Filled" FitContent="true" Disabled="@loading" T="TipoArticuloDTO" @bind-Value="tipoSeleccionado" Label="Listado" Style="min-width:200px" Class="ma-2">
                        <MudSelectItem T="TipoArticuloDTO" Value="@tipoDefault">@tipoDefault.Nombre</MudSelectItem>
                        @foreach (TipoArticuloDTO tipo in tipoArticulos)
                        {
                            <MudSelectItem T="TipoArticuloDTO" Value="@tipo">@tipo.Nombre</MudSelectItem>
                        }
                    </MudSelect>
                </MudItem>
                <MudItem xs="12" sm="6" md="2" Class="d-flex align-center">
                    <MudDatePicker Label="Fecha Inicio" Variant="Variant.Filled" Disabled="@loading" @bind-Date="inicio" />
                </MudItem>
                <MudItem xs="12" sm="6" md="2" Class="d-flex align-center">
                    <MudDatePicker Label="Fecha Fin" Variant="Variant.Filled"  Disabled="@loading" @bind-Date="fin"/>
                </MudItem>
                <MudItem xs="4" sm="3" md="2" Class="d-flex align-center">
                    <MudIconButton Style="height:fit-content" Color="Color.Primary" Variant="Variant.Filled" Icon="@Icons.Material.Filled.FilterAlt" />
                </MudItem>
                <MudItem xs="4" sm="1" md="1" Class="d-flex align-center">
                    <MudIconButton Style="height:fit-content" Color="Color.Primary" Variant="Variant.Filled" OnClick="ReloadTable" Icon="@Icons.Material.Filled.Search" />
                </MudItem>
                <MudItem xs="4" sm="1" md="1" Class="d-flex align-center">
                    <MudIconButton Style="height:fit-content" Disabled="@loading" Variant="Variant.Filled" Color="Color.Primary" Icon="@Icons.Material.Filled.Add" />
                </MudItem>
            </MudGrid>
        </MudPaper>
        <br/>
            <MudTable @ref="table" 
                     T="PedidoDTO" 
                     ServerData="ShowList"
                     Class="d-flex flex-column"
                     Style="height: 100%;"
                     FixedHeader="true"
                     FixedFooter="false"
                     Dense="true"
                     Hover="true"
                     >

                <HeaderContent>
                    <MudTh Style="font-weight: bold;"># Pedido</MudTh>
                    <MudTh Style="font-weight: bold;">Cantidad de Artículos</MudTh>
                    <MudTh Style="font-weight: bold;">Estado</MudTh>
                    <MudTh Style="font-weight: bold;">Comprador</MudTh>
                    <MudTh Style="font-weight: bold;">Vendedor</MudTh>
                    <MudTh Style="font-weight: bold;">Acciones</MudTh>
                </HeaderContent>
                <RowTemplate>
                    <MudTd DataLabel="# Pedido">@context.Id</MudTd>
                    <MudTd DataLabel="Cantidad de Artículos">@context.CantidadArticulos</MudTd>
                    <MudTd DataLabel="Estado">@context.EstadoNombre</MudTd>
                    <MudTd DataLabel="Comprador">@context.NombreComprador</MudTd>
                    <MudTd DataLabel="Vendedor">@context.UsuarioUsername</MudTd>
                    <MudTd DataLabel="Acciones">
                    <MudButtonGroup Size="Size.Small">
                        <MudIconButton Color="Color.Primary" Icon="@Icons.Material.Filled.Visibility"/>
                        <MudIconButton Icon="@Icons.Material.Filled.Delete" Color="Color.Secondary"/>
                    </MudButtonGroup>
                    </MudTd>
                </RowTemplate>
                <PagerContent>
                    <MudTablePager PageSizeOptions="new int[] { 10, 25, 50 }" />
                </PagerContent>
                <NoRecordsContent>
                    <div class="d-flex flex-column align-center justify-center pa-8">
                        <MudIcon Icon="@Icons.Material.Filled.SearchOff" Size="Size.Large" Class="mb-2" />
                        <MudText Typo="Typo.body1">No se encontraron registros.</MudText>
                    </div>
                </NoRecordsContent>
            </MudTable>
    </MudContainer>
</CustomView>


@code {
    private MudTable<PedidoDTO> table;
    private List<TipoArticuloDTO> tipoArticulos = new List<TipoArticuloDTO>();
    private TipoArticuloDTO tipoSeleccionado { get; set; } = new TipoArticuloDTO { Id = 0, Nombre = "Todos los pedidos" };
    private TipoArticuloDTO tipoDefault = new TipoArticuloDTO { Id = 0, Nombre = "Todos los pedidos" };
    private DateTime? inicio = DateTime.Today;
    private DateTime? fin = DateTime.Today;
    private bool loading = false;
    private int CurrentPage;

    protected override async Task OnInitializedAsync()
    {
        await LoadTipoArticulos();
    }

    private async Task ReloadTable()
    {
        if (table != null)
        {
            await table.ReloadServerData();
        }
    }

    private async Task<TableData<PedidoDTO>> ShowList(TableState state, CancellationToken token)
    {
        loading = true;
        // DEBUG
        await Task.Delay(1000, token);
        // DEBUG
        PaginacionDTO paginacionDTO = new PaginacionDTO
        {
            GetTotalItems = true,
            Page = state.Page,
            RecordsPerPage = state.PageSize,

        };
        ValidacionDTO valid = utilities.ValidarFechas(inicio, fin);
        if (!valid.EsValido)
        {
            Console.WriteLine(valid.Mensaje);
            loading = false;
            return new TableData<PedidoDTO>() { TotalItems = 0, Items = new List<PedidoDTO>() };
        }

        var response = await httpClient.PostAsJsonAsync("api/Pedido/GetListadoPedidos", new RequestDTO(paginacionDTO, inicio, fin), token);
        if (response.IsSuccessStatusCode)
        {
            var pedidos = await response.Content.ReadFromJsonAsync<ListadoDTO<PedidoDTO>>();
            if (pedidos == null)
            {
                pedidos = new ListadoDTO<PedidoDTO>();
            }
            loading = false;
            return new TableData<PedidoDTO>()
            {
                TotalItems = pedidos.TotalItems,
                Items = pedidos.Listado
            };
        }
        loading = false;
        return new TableData<PedidoDTO>() { TotalItems = 0, Items = new List<PedidoDTO>() };
    }


    private async Task LoadTipoArticulos()
    {
        loading = true;
        try
        {
            tipoSeleccionado = tipoDefault; // Inicializar con el valor por defecto
            var response = await httpClient.GetAsync("api/Articulo/GetTipoArticulos");
            if (response.IsSuccessStatusCode)
            {
                tipoArticulos = await response.Content.ReadFromJsonAsync<List<TipoArticuloDTO>>() ?? new List<TipoArticuloDTO>();
            }
            else
            {
                // Manejar error de la API
                Console.WriteLine($"Error al cargar tipos de artículos: {response.ReasonPhrase}");
            }
        }
        catch (Exception ex)
        {
            // Manejar excepciones
            Console.WriteLine($"Excepción al cargar tipos de artículos: {ex.Message}");
        }
        loading = false;
    }
}
